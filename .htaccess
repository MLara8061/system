# Apache Configuration con seguridad y routing
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  
  # Bloquear archivos .env en cualquier ruta
  RewriteRule \.env$ - [F,L]
  
  # Proteger directorios sensibles
  RewriteRule ^config/\.env$ - [F,L]
  RewriteRule ^logs/ - [F,L]
  RewriteRule ^database/ - [F,L]
  RewriteRule ^tests/ - [F,L]
  RewriteRule ^\.git - [F,L]
</IfModule>

# Alternativa sin mod_rewrite
<FilesMatch "^(\.env|.*\.(sql|bak|sh|ini))$">
  Require all denied
</FilesMatch>

# Bloquear acceso directo a vistas PHP (solo permitir archivos específicos)
<FilesMatch "\.php$">
  Require all denied
</FilesMatch>

# Permitir acceso a archivos públicos y modales
<FilesMatch "^(index|login|logout|ajax|ajax_simple|ajax_login|manage_user_modal|manage_comment|manage_ticket|manage_category|manage_department|manage_equipment_location|manage_inventory|manage_job_position|manage_services|generate_qr|generate_pdf|equipment_report_pdf|equipment_unsubscribe_pdf|equipment_unsubscribe_report|print_label|report_pdf|export_equipment|export_suppliers|equipment_public|view_equipment|view_inventory|view_ticket|admin_class|generate_excel_template|download_template|debug_unsubscribe|manual_usuario_pdf|descargar_manual|test_relations|check_structure|run_migration|test_save_department|assign_relations|assign_positions_locations|test_cascada|report_issue_public|save_public_ticket_direct|test_login|test_ajax_login|debug_ajax)\.php$">
  Require all granted
</FilesMatch>

# Permitir acceso a utilities (archivos de diagnóstico e instalación)
<Directory utilities>
  <FilesMatch "\.php$">
    Require all granted
  </FilesMatch>
</Directory>
# Permitir acceso a nuevas rutas organizadas
<Directory "app/views">
  <FilesMatch "\.php$">
    Require all granted
  </FilesMatch>
</Directory>

<Directory "app/helpers">
  <FilesMatch "\.php$">
    Require all granted
  </FilesMatch>
</Directory>

<Directory "public/ajax">
  <FilesMatch "\.php$">
    Require all granted
  </FilesMatch>
</Directory>

# Headers de seguridad adicionales
<IfModule mod_headers.c>
    # Prevenir MIME sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Prevenir clickjacking
    Header set X-Frame-Options "DENY"
    
    # XSS Protection
    Header set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# Compresión Gzip
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Cache Control para assets estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# Deshabilitar listado de directorios
Options -Indexes